# CanvasDesk X11 Window Manager Migration

**Last Updated:** 2025-12-04 (WINDOW MANAGER ENHANCEMENTS)
**Status:** Phase 3 - Fully Functional Stacking Window Manager
**See also:** do.txt (original Wayland progress notes - OUTDATED, Wayland removed)

---

## MAJOR SESSION (Dec 4) - WINDOW MANAGER COMPLETE:

### What Was Implemented Today:

1. **Minimize/Maximize Functionality** ‚úÖ
   - Minimize button: Iconifies window, updates state to "Minimized"
   - Maximize button: Toggles fullscreen with saved dimensions
   - Both buttons update window state and emit signals to QML
   - Proper dimension tracking (savedX, savedY, savedWidth, savedHeight)

2. **Window State Tracking** ‚úÖ
   - Added State enum: Normal, Minimized, Maximized
   - State exposed to QML via "state" field
   - Minimized windows stay in taskbar for restoration
   - Taskbar shows visual indicators (dimmed for minimized, ‚ñ° prefix for maximized)

3. **Taskbar Toggle Behavior** ‚úÖ
   - Left-click taskbar button: Toggle minimize/restore
   - Middle-click taskbar button: Close window gracefully
   - Visual feedback: 50% opacity + italic text + "_ " prefix for minimized windows

4. **Click-to-Focus** ‚úÖ
   - Any click on window (titlebar, buttons, frame) focuses it
   - Active window tracking with m_activeWindow
   - Focused windows raised to top automatically
   - Active state exposed to QML for taskbar highlighting

5. **Window Resizing by Edges/Corners** ‚úÖ
   - 5-pixel grab area at all edges
   - Drag any edge or corner to resize
   - Minimum size enforcement (100x74 pixels)
   - Real-time titlebar/button recreation during resize

6. **Resize Cursor Feedback** ‚úÖ
   - Cursor changes when hovering over resize edges:
     - Horizontal arrows (‚Üî) for left/right edges
     - Vertical arrows (‚Üï) for top/bottom edges
     - Diagonal arrows (‚Üñ‚Üò and ‚Üó‚Üô) for corners
   - Normal cursor on titlebar and interior
   - Created using standard X11 cursor fonts

7. **Titlebar Button Icons** ‚úÖ
   - Replaced Unicode symbols with X11 drawn primitives
   - Close: X shape using two diagonal lines
   - Maximize: Square outline
   - Minimize: Horizontal line
   - Clean, professional look with no font dependencies

8. **Bug Fixes** ‚úÖ
   - Fixed BadAccess error when selecting events on client windows
   - Prevented cursor changes on titlebar area (only edges)
   - Cleaned up verbose debug logging
   - All operations work smoothly without crashes

### Files Modified:
- `src/core/X11WindowManager.h` - Added state tracking, resize/cursor state, helper methods
- `src/core/X11WindowManager.cpp` - ~400 lines of new code for all features
- `src/core/WindowManager.cpp` - Added activate(), close(), minimize() implementations
- `src/editor/qml/components/TaskbarComponent.qml` - Added middle-click, state indicators

### Current Feature Set:
‚úÖ Window reparenting with titlebars
‚úÖ Window dragging by titlebar
‚úÖ Window resizing by edges/corners with cursor feedback
‚úÖ Minimize/Maximize/Close buttons (all functional)
‚úÖ Click-to-focus
‚úÖ Auto-focus on restore from taskbar
‚úÖ Window state tracking (Normal/Minimized/Maximized)
‚úÖ Taskbar integration with state indicators
‚úÖ Middle-click to close from taskbar
‚úÖ Clean geometric button icons (no fonts)
‚úÖ Theme-aware titlebar colors

### TODO - Next Session:
- [ ] Add app icons to titlebar (left side before title text)
- [ ] Get icon from X11 window properties or desktop file
- [ ] Render icon as small pixmap (16x16 or 24x24)

### Build Status:
‚úÖ All features tested and working
‚úÖ No crashes or errors
‚úÖ Dolphin and other apps work correctly
‚úÖ Resize cursors display properly
‚úÖ Binary ready: `/home/brad/Documents/canvasdesk/build/canvasdesk`

---

## BRAD UPDATE (Dec 3, 23:55) - BASIC THEMING SYSTEM:

### Decided to add in color theming:
Addded in wallpaper support, we pull several specific colors from the wallpaper, and then the user can click to assign a color to a theme element, we also have three "Universal" colors, White, Medium Grey and Black.

MOST of the QML UI elements are themed now, but not all, i am aware that the Session QML needs to be updated for the colors, Need to look in to a better font for the WindowManager's titlebar front and to make use of whatever "material icons" that KDE / Plasma may offer to replace the standard text in the control buttons in the titlebar (minimize, maximize, close)

NEED TO DO:
 - Figure out how both KDE and Gnome assign themed icons sets.
 - Migrate the Theme area to it's own sub-windows, like the Editor settings, as how it needs more space.
 - Figure out assigning Cursor sets, again, like Gnome and KDE.
 - make use of KDE and Gnomme Icons and Cursors.

---

## CRITICAL CRASH FIX (Dec 3, 23:15) - BUTTON WINDOW CLEANUP BUG:

### Bug Found:
When closing windows with the red X button, CanvasDesk would sometimes crash. Root cause identified:

**The Problem:**
- Button windows were added to `m_frames` hash in `createTitleBarButtons()`
- When `destroyFrame()` was called, it removed frame/titlebar/client from hash
- **BUT it forgot to remove button windows from the hash!**
- Then `XDestroyWindow()` was called on buttons
- X11 sends DestroyNotify events for those button windows
- Event handler calls `findFrame(btn.window)` ‚Üí finds dangling pointer ‚Üí **CRASH**

**The Fix (X11WindowManager.cpp:539-542):**
```cpp
// Remove button windows from hash BEFORE destroying them
for (const X11Button &btn : frame->buttons) {
    m_frames.remove(btn.window);
}
```

### Build Status:
‚úÖ **Build completed successfully** (Dec 3, 23:15)
‚úÖ Binary ready: `/home/brad/Documents/canvasdesk/build/canvasdesk`
‚úÖ **Close button should no longer crash the desktop!**

---

## COMPOSITING DISABLED (Dec 3, 23:08) - BACK TO BASICS:

### What Happened:
After multiple attempts to fix desktop input blocking with compositing enabled:
1. Tried double buffering + rate limiting ‚Üí Eliminated flickering, but desktop still non-responsive
2. Tried override_redirect on frames ‚Üí Desktop clicks still didn't work
3. Attempted Qt Controls migration ‚Üí Also failed to fix input issues

### Decision Made:
**DISABLED ALL COMPOSITING CODE** (commented out, not deleted)

### Why:
- Compositing is OPTIONAL for a window manager - it's only for effects/transparency
- Core window management (titlebars, dragging, close buttons) worked WITHOUT compositing
- Desktop was working fine before compositing was added
- User is frustrated and needs a working system NOW
- Can always re-enable compositing later once we figure out what was wrong

### What Was Disabled:
All code marked with `// DISABLED: Compositing disabled for now`
- XComposite extension initialization
- XRender extension initialization
- XDamage extension initialization
- XCompositeRedirectSubwindows() call
- CompositedWindow tracking
- paint() function with double buffering
- requestPaint() rate limiting
- handleMapNotify() compositing logic
- ConfigureNotify/CreateNotify handlers
- Damage event handling
- override_redirect flags on frames/buttons

### What Still Works:
‚úÖ X11 window manager registration
‚úÖ Window reparenting with titlebars
‚úÖ Window dragging by titlebar
‚úÖ Close/Minimize/Maximize buttons (close works, others not implemented)
‚úÖ Window title display
‚úÖ Basic window positioning
‚úÖ Taskbar integration
‚úÖ **Desktop components should be clickable again!**

### Build Status:
‚úÖ **Build completed successfully** (Dec 3, latest)
‚úÖ Binary ready: `/home/brad/Documents/canvasdesk/build/canvasdesk`

### Next Test:
User needs to log into CanvasDesk session and verify:
1. **Desktop components respond to clicks** (AppLauncher, SessionManager, etc.)
2. Windows still have titlebars and can be dragged
3. Close button (X) still works
4. No flickering or artifacts (apps draw themselves, no compositor)

---

## MAJOR CODE ROLLBACK (Dec 3, 23:30) - BACK TO FLICKERING VERSION:

### What Happened:
After extensive debugging of Qt Controls migration (Phase 5), desktop components still weren't responding to mouse input. Even after converting all MouseArea elements to proper Qt Quick Controls (Button, ItemDelegate, Label), the components appeared as flat elements and didn't receive clicks.

### Decision:
Rolled back to commit `ee9fca5` - "updated to use compositing in X11, titlebars, controls, flickers badly."

This is the version where:
- ‚úÖ Compositing was first enabled (XComposite + XRender + XDamage)
- ‚úÖ Titlebars work with window titles
- ‚úÖ Window dragging works
- ‚úÖ Close button (X) works
- ‚úÖ Desktop components (MouseArea-based) respond to clicks
- ‚ùå **Bad flickering** on built-in display (the AI "forgot to enable" something)

### Branches Created:
- `compositing-qt-controls-failed` - Saved the Qt Controls migration attempt (commit 49dc314)
- `compositing-fixes` - Empty placeholder at ee9fca5
- `qt-controls-attempt` - Empty placeholder at ee9fca5
- `master` - Reset to ee9fca5 (current working branch)

### Why This Version:
1. Components worked with MouseArea before compositing bugs
2. The "flickering" issue is likely a single missing enable/config
3. This gives us a known working baseline to fix from
4. All Qt Controls work was saved and can be cherry-picked later if needed

### Next Steps:
1. Test this version in real X11 session - verify components respond to clicks
2. Identify what was "forgotten" that causes flickering
3. Fix flickering issue (likely paint throttling or vsync)
4. Once stable, can revisit Qt Controls migration if needed

---

## ORIGINAL NOTES FROM THIS COMMIT (Dec 3, 20:10) - COMPOSITING SUPPORT:

### Issue Addressed:
- User reported "stuck" graphics and redraw artifacts when moving windows.
- Caused by lack of compositing (stacking WM relies on app repaints).

### Fix Applied:
- **Enabled XComposite:** Redirects all windows to off-screen pixmaps (`CompositeRedirectManual`).
- **Enabled XRender:** Composites window pixmaps onto the root window.
- **Enabled XDamage:** Tracks damage events to only repaint when necessary.
- **Implemented `paint()` loop:** Draws windows from bottom to top.

### Files Modified:
- `CMakeLists.txt`: Added `Xcomposite`, `Xrender`, `Xdamage` dependencies.
- `X11WindowManager.h`: Added `CompositedWindow` struct and extension bases.
- `X11WindowManager.cpp`: Implemented compositing initialization and render loop.

### Expected Result:
- No more "trails" or stuck graphics when moving windows.
- Smooth window movement.
- Foundation laid for transparency/effects later.

---

## PREVIOUS IMPLEMENTATION (Dec 3, 19:05) - DRAG & BUTTONS:

### What Was Added:
1. **Mouse Event Handlers**
   - `handleButtonPress()` - Detects button clicks on titlebar and buttons
   - `handleButtonRelease()` - Stops dragging
   - `handleMotionNotify()` - Handles mouse movement during drag
   - Added to event loop in `processXEvents()`

2. **Titlebar Dragging**
   - Click and hold on titlebar to drag window
   - Tracks drag state: start position, frame position
   - Updates window position in real-time with XMoveWindow
   - Smooth dragging experience

3. **Control Buttons**
   - Created 3 buttons in titlebar (right side):
     * Minimize (_) - Yellow (0xffff55) - Not yet functional
     * Maximize (O) - Green (0x55ff55) - Not yet functional
     * Close (X) - Red (0xff5555) - **WORKS!**
   - Each button is a separate X11 window
   - Simple text symbols: "_", "O", "X"
   - Close button sends WM_DELETE_WINDOW protocol message

4. **Code Structure**
   - `createTitleBarButtons()` - Creates button windows
   - `drawTitleBarButton()` - Draws button symbols
   - Drag state tracked in member variables
   - Button windows mapped to frames in m_frames hash

### Files Modified:
- `src/core/X11WindowManager.h` - Added event handlers, drag state
- `src/core/X11WindowManager.cpp` - ~190 lines of new code

### Testing:
- Build successful ‚úì
- Ready to test in real session

---

## CRITICAL FIXES APPLIED (Dec 3 Evening):

### 1. Fixed Session Installation (main.cpp)
**Problem:** Session installer was still pointing to Wayland paths
**Fixed in:** src/main.cpp lines 71, 92, 108-109, 122
- Changed `/usr/share/wayland-sessions` ‚Üí `/usr/share/xsessions`
- Updated desktop entry comment: "Wayland" ‚Üí "X11 Desktop Environment with Built-in Window Manager"
- Updated install message to mention xcb-util-cursor requirement
- Rebuilt successfully

### 2. Enhanced Session Script (canvasdesk-session)
**Problem:** Script didn't check if DISPLAY was set, no debug output
**Fixed in:** canvasdesk-session lines 24-36, 49
- Added environment variable debug output (DISPLAY, XDG_SESSION_TYPE, USER)
- Added check for DISPLAY - exits with error if not set
- Added `export XDG_SESSION_TYPE=x11`
- Script now validates X server is running before launching CanvasDesk

### 3. Session File Successfully Installed
**Verified:**
- File exists: `/usr/share/xsessions/canvasdesk.desktop` ‚úÖ
- Points to: `/home/brad/Documents/canvasdesk/canvasdesk-session` ‚úÖ
- Will appear in SDDM login screen as "CanvasDesk" ‚úÖ

### 4. X11 Connection Test Passed
**Created:** test-x11-connection.sh (for pre-login testing)
**Test Results:**
- ‚úÖ X11 connection works (tested via Xwayland in Plasma)
- ‚úÖ DISPLAY properly set (:0)
- ‚úÖ No Qt platform plugin errors
- ‚úÖ CanvasDesk binary runs without crashing
- ‚úÖ xcb-util-cursor library already installed

---

## CURRENT STATE

### ‚úÖ COMPLETED (Phase 1, 2 & 3a):
1. **Removed all Wayland code:**
   - Deleted: WlrWindowManager, ExtForeignToplevelManager
   - Updated: CMakeLists.txt (removed Wayland deps, added X11/XCB)
   - Updated: canvasdesk-session script (now uses X11, no Wayfire)
   - Updated: DEPENDENCIES.txt

2. **Implemented X11 Window Manager with Titlebars:**
   - Created: X11WindowManager.cpp/h
   - Features working:
     * X11 connection and WM registration (SubstructureRedirect)
     * Window tracking (MapRequest, UnmapNotify, DestroyNotify)
     * **Window reparenting into frames** ‚úì
     * **Titlebar rendering with window titles** ‚úì
     * Property updates (window title, app ID)
     * Qt event loop integration via QSocketNotifier
     * Window list exposed to QML/Taskbar
     * Filters out CanvasDesk from window list
     * Basic positioning (100,100 @ 800x600)
     * Frame structure: outer frame + titlebar + client window
     * Titlebar colors: #3c3c3c background, white text
     * Border: #444444, 1px width

3. **Fixed AppLauncher:**
   - Now inherits DISPLAY environment variable
   - Apps launch in same X session as CanvasDesk

### ‚úÖ NEWLY COMPLETED (Phase 3b - Dec 3, 19:05):
- **Mouse dragging windows by titlebar** ‚úì
- **Titlebar control buttons (minimize, maximize, close)** ‚úì
  - Close button (X) - Red background - Sends WM_DELETE_WINDOW
  - Maximize button (O) - Green background - Not yet functional
  - Minimize button (_) - Yellow background - Not yet functional
- **Button click handling** ‚úì
- **Window dragging works!** ‚úì

### ‚ùå NOT YET IMPLEMENTED:
- Window resizing (edges/corners) - Phase 3c
- Minimize functionality (iconify window)
- Maximize functionality (fullscreen toggle)
- Focus management / active window tracking - Phase 3d
- Keyboard shortcuts (Alt+Tab, etc.) - Phase 3e
- Multi-monitor support (XRandR) - Phase 4
- Compositing effects - Phase 4 (optional)

---

## TESTING NOTES

### Xephyr Testing (Nested X Server):
**Result:** INCONCLUSIVE - Apps launching in main Plasma session instead

**Issue identified:**
- When running `DISPLAY=:1 canvasdesk --runtime` in Xephyr
- Launching HandBrake via AppLauncher showed Plasma/KWin titlebar
- App appeared in main Wayland session, not Xephyr
- This suggests environment isolation issue with nested X server

**Debug log showed:**
```
[X11] Successfully registered as window manager
‚úì X11 window manager active
Launching: "ghb"  ‚Üê HandBrake launched but appeared in Plasma
```

**Conclusion:** Need to test in REAL X11 session, not nested Xephyr

---

## ‚úÖ REAL SESSION TEST - SUCCESSFUL! (Dec 3, 2025 - 18:38)

**Test Result:** COMPLETE SUCCESS - CanvasDesk is working as a full X11 window manager!

### What Works:
‚úÖ Session login via SDDM - selected "CanvasDesk" from session menu
‚úÖ X11 window manager registration and event handling
‚úÖ Apps launching and being tracked (Claude Code, Alacritty, Konsole, Dolphin, etc.)
‚úÖ Window list updates and taskbar integration
‚úÖ System feels responsive and stable
‚úÖ Neofetch confirms: `WM: CanvasDesk (X11)`
‚úÖ **TITLEBARS NOW WORKING!** (as of 19:00) - All windows get server-side decorations

### Issues Discovered:
1. **~~Client-Side Decorations (CSD) work, Server-Side don't exist yet~~** ‚úÖ FIXED!
   - ‚úÖ Implemented window reparenting + frame windows
   - ‚úÖ All windows now have titlebars with window title text
   - ‚úÖ Titlebar renders at top of frame with gray background
   - Screenshot: temp-claude-titlebars.png shows working titlebar

2. **Taskbar doesn't update on window close**
   - Hidden/unmapped windows still show in taskbar
   - Closing Alacritty hid window but kept taskbar button
   - Reopening Dolphin removed it from taskbar (window was just hidden)
   - **Cause:** Need to differentiate UnmapNotify (hide) vs DestroyNotify (close)
   - **Solution:** Better event handling in X11WindowManager

3. **Extended monitors have no video output**
   - Laptop internal display works perfectly
   - External monitors show no output
   - **Cause:** X11 multi-monitor (RandR) configuration not implemented
   - **Solution:** Investigate XRandR integration (Phase 3 or 4)

### User Feedback:
- **"Pretty responsive honestly"**
- **"Surprised at how nice it feels"**
- Reminds user of early TWM days (geometry drawing for xterm)

### Screenshot:
- Taken at 18:38:55
- Shows CanvasDesk bottom panel with Apps/Home/Built-in/etc menus
- Clock, Lock Screen, Logout, Reboot buttons working
- Multiple windows open: Claude Code, fish terminal with neofetch
- File: `2025-12-03-183855_2560x1440_scrot.png`

---

## NEXT STEPS - PHASE 3: WINDOW DECORATIONS (READY TO START!)

### Session Installation Status:
‚úÖ Session file installed: `/usr/share/xsessions/canvasdesk.desktop`
‚úÖ Session script updated with debug logging
‚úÖ X11 connection verified working
‚úÖ Binary rebuilt with all fixes
‚úÖ Pre-flight test passed - no crashes

### How to Test:
1. **Log out of current Plasma session**
2. **At login screen (SDDM):** Look for session selector dropdown/gear icon
3. **Select "CanvasDesk"** from the session list
4. **Login** - SDDM will:
   - Start fresh X11 server
   - Set DISPLAY environment variable
   - Run `/home/brad/Documents/canvasdesk/canvasdesk-session`
   - Session script will launch CanvasDesk as window manager
5. **Check the log immediately if it fails:**
   ```bash
   ls -lt /tmp/canvasdesk-session-*.log | head -1
   cat /tmp/canvasdesk-session-<timestamp>.log
   ```
6. **If successful, test window management:**
   - Use AppLauncher to open apps (alacritty, firefox, etc.)
   - Check if windows appear and are tracked in taskbar
   - Windows should appear at 100,100 position (no decorations yet)

### What to Expect:
‚úì Apps should launch with CanvasDesk as the WM
‚úì Windows appear at 100,100 position
‚úì Taskbar shows window titles/icons
‚úì No KWin/Plasma interference
‚ùå No titlebars yet (just plain windows)
‚ùå Can't drag/resize windows with mouse yet
‚ùå Windows might overlap (no tiling/stacking logic yet)

### Expected Debug Output (in session log):
```
Environment check:
  DISPLAY=:0
  XDG_SESSION_TYPE=x11
  USER=brad

Starting CanvasDesk X11 session...
[X11] Initializing X11 window manager...
[X11] Successfully registered as window manager
‚úì X11 window manager active
[X11] ü™ü New window map request: <window-id>
[WindowManager] Window list changed
```

### If Test Fails - Troubleshooting:
1. **Check the session log:**
   ```bash
   ls -lt /tmp/canvasdesk-session-*.log | head -1
   cat <that-log-file>
   ```

2. **Common errors and fixes:**
   - **"ERROR: DISPLAY not set"** ‚Üí SDDM issue, check SDDM logs: `journalctl -b -0 | grep sddm`
   - **"could not connect to display"** ‚Üí X server not started, check Xorg log: `/var/log/Xorg.0.log`
   - **"Another window manager is already running"** ‚Üí Should NOT happen in clean session
   - **Qt platform plugin errors** ‚Üí Check xcb libraries: `pacman -Qs xcb-util`
   - **Core dump/crash** ‚Üí Check coredump: `journalctl -b -0 | grep canvasdesk`

3. **Verify files:**
   - Session file: `cat /usr/share/xsessions/canvasdesk.desktop`
   - Session script: `cat /home/brad/Documents/canvasdesk/canvasdesk-session`
   - Binary exists: `ls -lh /home/brad/Documents/canvasdesk/build/canvasdesk`

4. **Test X11 connection manually:**
   ```bash
   cd /home/brad/Documents/canvasdesk
   ./test-x11-connection.sh
   ```

---

## ARCHITECTURE SUMMARY

### File Structure:
```
src/core/
‚îú‚îÄ‚îÄ WindowManager.cpp/h        ‚Üê Main WM interface (exposed to QML)
‚îú‚îÄ‚îÄ X11WindowManager.cpp/h     ‚Üê X11-specific implementation
‚îî‚îÄ‚îÄ AppManager.cpp/h           ‚Üê App launching (inherits DISPLAY now)
```

### How It Works:
1. **X11WindowManager** connects to X server (via DISPLAY env var)
2. Registers as WM using `XSelectInput(root, SubstructureRedirectMask)`
3. X server sends events to our process for ALL window operations
4. **MapRequest** event ‚Üí create window, track it, map it, position it
5. **PropertyNotify** event ‚Üí update title/appId
6. **DestroyNotify** event ‚Üí remove from tracking
7. Qt's `QSocketNotifier` integrates X11 fd with Qt event loop
8. WindowManager exposes window list to QML via `windows()` property
9. Taskbar reads window list and displays buttons

### Key X11 Concepts:
- **SubstructureRedirect:** Only one WM can have this on root window
- **MapRequest:** App wants to show window, WM must XMapWindow() it
- **Reparenting:** (Not implemented yet) WM creates frame window around app
- **ConfigureRequest:** App wants to resize/move, WM approves it

---

## PHASE 3 ROADMAP (After Real Session Test Passes)

### Priority 1: Titlebars (Window Reparenting)
Reference: NoteWM's `frame.c`
- Create frame window for each managed window
- Reparent client window into frame
- Draw titlebar with buttons (close, minimize, maximize)
- Handle mouse events on titlebar (dragging)

### Priority 2: Mouse Window Management
- Detect mouse button press on window
- Implement dragging (update window position)
- Implement resizing (detect edges, update size)
- Cursor changes at window edges

### Priority 3: Focus Management
- Track active window
- Handle FocusIn/FocusOut events
- Update window borders to show active state
- Update taskbar to highlight active window button

### Priority 4: Keyboard Shortcuts
- Register X11 key grabs (Alt+Tab, Alt+F4, etc.)
- Implement window cycling (Alt+Tab)
- Implement window close (Alt+F4)
- Consider using Qt's shortcut system

---

## REFERENCE CODEBASES

**Using as reference (NOT directly integrating):**

1. **NoteWM** - https://github.com/masonarmand/NoteWM
   - Best for: Titlebar/frame implementation (frame.c)
   - Language: C
   - Size: ~2000 lines
   - Features: Floating WM with decorations

2. **x-compositing-wm** - https://github.com/obiwac/x-compositing-wm
   - Best for: Compositing implementation (XComposite, XDamage, XRender)
   - Language: C
   - Features: Compositing WM example with transparency/effects
   - Use alongside NoteWM for Phase 4 (compositing)

3. **basic_wm** - https://github.com/jichu4n/basic_wm
   - Best for: Learning X11 WM concepts
   - Language: C++
   - Educational, well-documented

4. **¬µwm (uwm)** - https://github.com/Johns-Q/uwm
   - Best for: Complete feature reference
   - Language: C
   - Size: ~23k lines
   - Features: Panels, menus, extensive WM features

---

## BACKUP & SAFETY

**Wayland version backed up as .zip file** ‚úì
- Can restore if X11 migration fails
- Located: [user has .zip backup]

**Testing Strategy:**
1. ‚úì Xephyr nested X server (DONE - but apps escaped to Plasma)
2. ‚Üí Real session test (NEXT - need to log out/in)
3. ‚Üí Gradual feature addition (Phase 3+)

---

## KNOWN ISSUES

1. **~~Xephyr apps escape to main session~~** ‚úÖ FIXED - Not using Xephyr anymore
   - Using real X11 session now instead of nested testing
   - Previous issue: Apps launched in Xephyr appeared in Plasma instead
   - SOLUTION: Test in real session (current approach)

2. **~~Session installer pointed to Wayland~~** ‚úÖ FIXED (Dec 3 evening)
   - Was installing to `/usr/share/wayland-sessions` instead of `/usr/share/xsessions`
   - Fixed in src/main.cpp lines 71, 92, 122
   - Reinstalled session file to correct location

3. **~~Session script didn't validate DISPLAY~~** ‚úÖ FIXED (Dec 3 evening)
   - Script now checks DISPLAY is set before launching
   - Logs environment variables for debugging
   - Sets XDG_SESSION_TYPE=x11

4. **No window decorations yet**
   - Windows have no titlebars
   - Can't drag or close windows with mouse
   - SOLUTION: Implement reparenting (Phase 3)

3. **Fixed window positioning**
   - All windows appear at 100,100
   - No smart placement algorithm
   - SOLUTION: Add positioning logic later

4. **No focus tracking**
   - Active window not tracked
   - All windows show as inactive in taskbar
   - SOLUTION: Track FocusIn events (Phase 3)

---

## BUILD COMMANDS

```bash
# Clean build
rm -rf build && mkdir build && cd build && cmake .. && cd .. && cd build && make -j$(nproc) && cd ..

# Incremental build (from project root)
cd build && make -j$(nproc) && cd ..

# Install session (for login screen) - MUST USE SUDO
sudo ./build/canvasdesk --installsession

# Uninstall session
sudo ./build/canvasdesk --uninstallsession

# Test X11 connection (before logging out)
./test-x11-connection.sh

# Run as real session (after login)
# Select "CanvasDesk" from SDDM session menu
# Session script automatically runs the binary
```

## FILES MODIFIED (Dec 3 Evening Session):
- `src/main.cpp` - Fixed session paths (wayland ‚Üí x11)
- `canvasdesk-session` - Added DISPLAY validation and debug logging
- `test-x11-connection.sh` - NEW: Pre-login X11 test script
- `/usr/share/xsessions/canvasdesk.desktop` - Reinstalled to correct location
- `X11.txt` - THIS FILE (updated with fixes)

---

## IMPORTANT NOTES FOR CLAUDE

**When resuming work on this project:**
1. **READ THIS FILE FIRST** (X11.txt) - Contains current state
2. do.txt is OUTDATED (old Wayland notes - for reference only)
3. **Current phase:** About to test real X11 session (all fixes applied)
4. **Immediate next step:** User logs out, selects CanvasDesk, logs in
5. **After successful test:** Begin Phase 3 (titlebars/reparenting using NoteWM as reference)

**Critical fixes applied (Dec 3 evening):**
- Session installer now uses `/usr/share/xsessions` (NOT wayland-sessions)
- Session script validates DISPLAY and logs environment
- X11 connection pre-tested and working
- Session file successfully installed and verified

**Always update this file when:**
- Completing a major task
- Discovering new issues
- Changing architecture
- Adding/removing features
- Before ending a coding session

**Code locations:**
- Window Manager: `src/core/X11WindowManager.cpp`
- Integration: `src/core/WindowManager.cpp`
- App Launcher: `src/core/AppManager.cpp`
- Build config: `CMakeLists.txt`, `src/core/CMakeLists.txt`
- Session script: `canvasdesk-session`

---

## DESKTOP INPUT FIX APPLIED! (Dec 3, 23:55) - OVERRIDE_REDIRECT FOR FRAMES

### What Was Fixed:
After applying the double buffering fix (which eliminated flickering), desktop UI components became non-clickable. The root cause was identified:

**Problem:**
- Frame windows (titlebars) were being added to the compositor's m_compositedWindows
- These frame windows were being painted over the CanvasDesk desktop
- The composited frame windows blocked mouse input to the desktop UI below
- This is why buttons like AppLauncher, SessionManager, etc. didn't respond to clicks

**Solution:**
- Set `override_redirect = True` on all frame windows (frame, titlebar, buttons)
- Added check in handleMapNotify to skip override_redirect windows from compositing
- Frame windows are now rendered directly by X11, not composited
- They stay on top but don't block input to windows below

### Code Changes (Dec 3, 23:55):
- `X11WindowManager.cpp` createFrame():
  - Added XSetWindowAttributes with override_redirect = True
  - Applied to frame->frame and frame->titleBar
- `X11WindowManager.cpp` createTitleBarButtons():
  - Added override_redirect = True to all button windows
- `X11WindowManager.cpp` handleMapNotify():
  - Added check to skip frame windows (m_frames.contains(w))
  - Added check to skip override_redirect windows
  - Prevents frame windows from being added to compositing

### Expected Results:
‚úÖ Desktop components (AppLauncher, SessionManager, etc.) should respond to clicks
‚úÖ Window titlebars still work and are visible
‚úÖ Window dragging still works
‚úÖ Close/minimize/maximize buttons still work
‚úÖ No flickering (double buffering still active)
‚úÖ No artifacts when dragging windows

### Testing Plan (Dec 3, 23:55):
When testing this build, check for:

**SUCCESS CASE:**
- Can click on AppLauncher button ‚Üí App grid appears
- Can click apps in grid ‚Üí Apps launch
- Can click SessionManager buttons ‚Üí Actions happen
- Visual feedback works (buttons highlight, etc.)

**FAILURE CASE - If desktop still doesn't respond to clicks:**
There's a fundamental issue with compositing blocking input. Next step: **Disable compositing entirely**.

**PARTIAL FAILURE - If clicks work but no visual feedback:**
- This happens if MouseArea components update internally but composited pixmap doesn't refresh
- Issue: Most desktop components use MouseArea (not Button), so they don't get damage events
- Same solution: **Disable compositing entirely**

### Backup Plan: Disable Compositing (If This Doesn't Work)

If the override_redirect fix doesn't solve the input issue, we'll remove compositing:

**What to Remove:**
- XCompositeRedirectSubwindows call
- All XRender picture/compositing code
- XDamage tracking
- paint() loop with back buffer
- m_compositedWindows hash

**What to Keep:**
- Frame windows (titlebars) - they work without compositing
- Window management (map, unmap, destroy, reparenting)
- Input handling (dragging, button clicks)
- Basic window positioning

**Result:** Simple, reliable stacking window manager. No fancy effects, but rock-solid desktop input and window management.

**Trade-off:** Lose ability to do transparency/shadows/effects later, but gain stability and simplicity.

---

## FLICKERING FIX APPLIED! (Dec 3, 23:45) - DOUBLE BUFFERING + RATE LIMITING

### What Was Fixed:
After rolling back to the flickering version (ee9fca5), we identified and fixed the root causes:

1. **Added Double Buffering in paint():**
   - Created off-screen Pixmap back buffer
   - Render all windows to back buffer first
   - Copy completed frame to screen in ONE atomic operation
   - This eliminates visible tearing and flicker

2. **Added Paint Rate Limiting (60 FPS):**
   - QTimer with 16ms interval (60 FPS)
   - requestPaint() queues paint requests instead of calling paint() directly
   - Prevents excessive repaints (was happening hundreds of times per second)

3. **Removed XFlush from Mouse Drag:**
   - XFlush during handleMotionNotify caused visible tearing
   - Now paint timer handles flushing at steady 60 FPS

### Code Changes:
- X11WindowManager.h: Added QTimer include, m_paintTimer, m_paintRequested members
- X11WindowManager.cpp:
  - Added requestPaint() method
  - Initialize paint timer in initialize()
  - Modified paint() to use double buffering
  - Replaced all paint() calls with requestPaint()
  - Removed XFlush from handleMotionNotify

### Build Status:
‚úÖ **Build completed successfully** (Dec 3, 23:45)
‚úÖ Binary ready: `/home/brad/Documents/canvasdesk/build/canvasdesk`

## CURRENT TEST PLAN (Dec 3, 23:45) - TESTING FIXED VERSION

### What to Test When Logging In:
1. **Desktop Components Responsiveness:**
   - Click AppLauncher button ‚Üí Should open app grid
   - Click app icons in grid ‚Üí Should launch apps
   - Click Taskbar buttons ‚Üí Should activate windows
   - Click Clock ‚Üí Should show time
   - Click SessionManager buttons (Lock, Logout, etc.) ‚Üí Should work

2. **Window Management:**
   - Drag window titlebar ‚Üí Should move window
   - Click Close (X) button ‚Üí Should close window
   - Windows should have proper titlebars with titles

3. **Flickering Issue (PRIMARY CONCERN):**
   - **Watch for rapid screen flickering/flashing**
   - Note if it happens:
     - Constantly (idle)
     - During window dragging
     - During window map/unmap
     - Only on certain monitors
   - This is the "forgot to enable" issue we need to identify

### Expected Behavior:
‚úÖ All components respond to clicks (MouseArea-based)
‚úÖ Windows have titlebars and can be dragged
‚úÖ Apps launch and are tracked in taskbar
‚úÖ **NO FLICKERING!** - Double buffering + rate limiting should eliminate flicker
‚úÖ Smooth 60 FPS window dragging
‚úÖ No visible tearing or artifacts

### What to Look For:
- The flickering was described as "flickers badly"
- Some AI mentioned "I forgot to enable [something]"
- This might be:
  - Missing vsync
  - Missing double buffering
  - Excessive paint() calls
  - Missing XDamage event filtering
  - Missing compositor sync

### After Testing:
Report back:
1. Do components respond to clicks? (Yes/No)
2. **Is the flickering GONE?** (This is the key test!)
3. How smooth is window dragging? (Should be 60 FPS)
4. Any error messages in terminal or log
5. Does it feel better than the Qt Controls version?

### If Flickering Still Exists:
- Note when it happens (idle, drag, etc.)
- We may need to adjust timer interval or add vsync
- May need to check desktop window exclusion logic

---

END OF X11.txt
