#!/bin/bash
# CanvasDesk Session Wrapper
# This script launches CanvasDesk as a desktop environment.
# If no display server is running, it starts wayfire compositor first.

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Set up debug log file
LOG_FILE="/tmp/canvasdesk-session-$(date +%Y%m%d-%H%M%S).log"
echo "CanvasDesk Session Log - $(date)" > "$LOG_FILE"
echo "======================================" >> "$LOG_FILE"
echo "" >> "$LOG_FILE"

# Redirect all output to log file AND console
exec > >(tee -a "$LOG_FILE") 2>&1

echo "Debug log will be saved to: $LOG_FILE"

# Path to the CanvasDesk binary
# When installed system-wide, this will be in /usr/bin or similar
CANVASDESK_BIN="${SCRIPT_DIR}/build/canvasdesk"

# Check if we need to start a compositor
COMPOSITOR_PID=""

if [ -z "$WAYLAND_DISPLAY" ] && [ -z "$DISPLAY" ]; then
    echo "No display server detected, starting wayfire compositor..."

    # Check if wayfire is installed
    if ! command -v wayfire &> /dev/null; then
        echo "ERROR: wayfire compositor not found!"
        echo "Please install it: sudo pacman -S wayfire"
        exit 1
    fi

    # Start wayfire in the background
    wayfire &
    COMPOSITOR_PID=$!

    # Give the compositor time to start
    sleep 2

    # Detect which Wayland socket wayfire created
    # Check XDG_RUNTIME_DIR for wayland-* sockets created in the last 5 seconds
    RUNTIME_DIR="${XDG_RUNTIME_DIR:-/run/user/$(id -u)}"
    DETECTED_DISPLAY=$(find "$RUNTIME_DIR" -maxdepth 1 -name "wayland-*" -type s -newermt "5 seconds ago" 2>/dev/null | head -1 | xargs basename 2>/dev/null)

    if [ -n "$DETECTED_DISPLAY" ]; then
        export WAYLAND_DISPLAY="$DETECTED_DISPLAY"
        echo "Detected Wayland display: $WAYLAND_DISPLAY"
    else
        # Fallback: try wayland-0, wayland-1, etc.
        for i in {0..5}; do
            if [ -S "$RUNTIME_DIR/wayland-$i" ]; then
                export WAYLAND_DISPLAY="wayland-$i"
                echo "Found Wayland display: $WAYLAND_DISPLAY"
                break
            fi
        done
    fi

    if [ -z "$WAYLAND_DISPLAY" ]; then
        echo "ERROR: Could not detect Wayland display socket!"
        kill $COMPOSITOR_PID 2>/dev/null
        exit 1
    fi

    # Tell CanvasDesk we're running as a full desktop session
    export CANVASDESK_SESSION_MODE=1

    echo "Compositor started with PID: $COMPOSITOR_PID"
else
    echo "Display server already running (WAYLAND_DISPLAY=$WAYLAND_DISPLAY, DISPLAY=$DISPLAY)"
fi

# Set Qt platform to Wayland
export QT_QPA_PLATFORM=wayland

# Launch CanvasDesk
echo "Starting CanvasDesk..."
"$CANVASDESK_BIN" --runtime

# If we started a compositor, kill it when CanvasDesk exits
if [ -n "$COMPOSITOR_PID" ]; then
    echo "Stopping compositor (PID: $COMPOSITOR_PID)..."
    kill $COMPOSITOR_PID 2>/dev/null
    wait $COMPOSITOR_PID 2>/dev/null
fi

echo "CanvasDesk session ended."
echo ""
echo "======================================"
echo "Debug log saved to: $LOG_FILE"
echo "======================================"
