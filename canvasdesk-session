#!/bin/bash
# CanvasDesk Session Wrapper
# This script launches CanvasDesk as a desktop environment.
# CanvasDesk includes its own X11 window manager, so no external WM is needed.

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Set up debug log file
LOG_FILE="/tmp/canvasdesk-session-$(date +%Y%m%d-%H%M%S).log"
echo "CanvasDesk Session Log - $(date)" > "$LOG_FILE"
echo "======================================" >> "$LOG_FILE"
echo "" >> "$LOG_FILE"

# Redirect all output to log file AND console
exec > >(tee -a "$LOG_FILE") 2>&1

echo "Debug log will be saved to: $LOG_FILE"

# Path to the CanvasDesk binary
# When installed system-wide, this will be in /usr/bin or similar
CANVASDESK_BIN="${SCRIPT_DIR}/build/canvasdesk"

# Debug: Print environment
echo "Environment check:"
echo "  DISPLAY=$DISPLAY"
echo "  XDG_SESSION_TYPE=$XDG_SESSION_TYPE"
echo "  USER=$USER"
echo ""

# Ensure DISPLAY is set (should be set by display manager)
if [ -z "$DISPLAY" ]; then
  echo "ERROR: DISPLAY environment variable not set!"
  echo "This script should be launched by a display manager (SDDM/GDM) which starts X server."
  exit 1
fi

# Set cursor theme
export XCURSOR_THEME=Adwaita
export XCURSOR_SIZE=24

# Set Qt platform to X11
export QT_QPA_PLATFORM=xcb

# Tell CanvasDesk we're running as a full desktop session
export CANVASDESK_SESSION_MODE=1

# Set XDG session type
export XDG_SESSION_TYPE=x11

# Launch CanvasDesk - it will act as the X11 window manager
echo "Starting CanvasDesk X11 session..."
"$CANVASDESK_BIN" --runtime

echo "CanvasDesk session ended."
echo ""
echo "======================================"
echo "Debug log saved to: $LOG_FILE"
echo "======================================"
